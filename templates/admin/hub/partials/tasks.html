<section id="admin-hub-tasks"
    data-refresh-url="{% url 'admin_hub_tasks_fragment' %}"
    data-indicator="#admin-hub-tasks-indicator">

    <div class="bg-cream-50/90 dark:bg-sage-900/90 border border-sage-200 dark:border-sage-800 rounded-3xl shadow-2xl p-6">
        <div class="flex items-center justify-between flex-wrap gap-4 mb-4">
            <div>
                <p class="uppercase tracking-[0.35em] text-xs text-sage-500 dark:text-sage-400">Mission Control</p>
                <h2 class="text-2xl font-serif font-semibold">Task Board</h2>
                <p class="text-xs text-sage-500 dark:text-sage-400 mt-1">Automatic refresh whenever someone changes a task.</p>
            </div>
            <div class="flex items-center gap-3 text-xs text-sage-500 dark:text-sage-400">
                <span class="hidden htmx-indicator" id="admin-hub-tasks-indicator">Updatingâ€¦</span>
                <button type="button" data-refresh-target="admin-hub-tasks" class="inline-flex items-center gap-2 rounded-full border border-sage-200 dark:border-sage-700 px-4 py-1.5 text-xs font-semibold text-sage-700 dark:text-cream-100 hover:bg-sage-100/60 dark:hover:bg-sage-800/40 transition">Refresh now</button>
            </div>
        </div>

        <form method="get" action="{% url 'admin_hub' %}" class="form-grid md-three mb-6">
            <select name="status" class="rounded-2xl border border-sage-200 dark:border-sage-700 bg-white/90 dark:bg-sage-950/70 px-4 py-2 text-sm text-sage-800 dark:text-cream-100">
                <option value="">All Statuses</option>
                {% for option in admin_hub.task_status_options %}
                <option value="{{ option.value }}" {% if admin_hub.task_filter.status == option.value %}selected{% endif %}>{{ option.label }}</option>
                {% endfor %}
            </select>
            <select name="priority" class="rounded-2xl border border-sage-200 dark:border-sage-700 bg-white/90 dark:bg-sage-950/70 px-4 py-2 text-sm text-sage-800 dark:text-cream-100">
                <option value="">All Priorities</option>
                {% for option in admin_hub.task_priority_options %}
                <option value="{{ option.value }}" {% if admin_hub.task_filter.priority == option.value %}selected{% endif %}>{{ option.label }}</option>
                {% endfor %}
            </select>
            <div class="flex gap-2">
                <input type="text" name="q" value="{{ admin_hub.task_filter.query }}" placeholder="Search title, description, or assignee" class="flex-1 rounded-2xl border border-sage-200 dark:border-sage-700 bg-white/90 dark:bg-sage-950/70 px-4 py-2 text-sm text-sage-800 dark:text-cream-100" />
                <button type="submit" class="rounded-2xl bg-gradient-to-r from-sage-700 to-sage-900 dark:from-sage-500 dark:to-sage-600 text-white px-4 py-2 text-sm font-semibold shadow">Filter</button>
            </div>
        </form>

        <details class="mb-6" open>
            <summary class="cursor-pointer text-sm text-sage-600 dark:text-sage-300 mb-3">
                Log a new task
            </summary>
            <form method="post" action="{% url 'chat_task_create' %}" hx-post="{% url 'chat_task_create' %}" hx-target="#admin-hub-tasks" hx-swap="outerHTML" hx-indicator="#admin-hub-tasks-indicator" class="grid gap-3">
                {% csrf_token %}
                <input type="text" name="title" placeholder="Task title" class="rounded-2xl border border-sage-200 dark:border-sage-700 bg-white/90 dark:bg-sage-950/70 px-4 py-2 text-sm text-sage-800 dark:text-cream-100" required>
                <textarea name="description" rows="3" placeholder="Brief description" class="rounded-2xl border border-sage-200 dark:border-sage-700 bg-white/90 dark:bg-sage-950/70 px-4 py-2 text-sm text-sage-800 dark:text-cream-100"></textarea>
                <div class="form-grid md-two">
                    <select name="priority" class="rounded-2xl border border-sage-200 dark:border-sage-700 bg-white/90 dark:bg-sage-950/70 px-4 py-2 text-sm text-sage-800 dark:text-cream-100" required>
                        {% for option in admin_hub.task_priority_options %}
                        <option value="{{ option.value }}">{{ option.label }}</option>
                        {% endfor %}
                    </select>
                    <select name="status" class="rounded-2xl border border-sage-200 dark:border-sage-700 bg-white/90 dark:bg-sage-950/70 px-4 py-2 text-sm text-sage-800 dark:text-cream-100" required>
                        {% for option in admin_hub.task_status_options %}
                        <option value="{{ option.value }}">{{ option.label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-grid md-two">
                    <input type="date" name="due_date" class="rounded-2xl border border-sage-200 dark:border-sage-700 bg-white/90 dark:bg-sage-950/70 px-4 py-2 text-sm text-sage-800 dark:text-cream-100" />
                    <select name="assigned_to" class="rounded-2xl border border-sage-200 dark:border-sage-700 bg-white/90 dark:bg-sage-950/70 px-4 py-2 text-sm text-sage-800 dark:text-cream-100">
                        <option value="">Unassigned</option>
                        {% for user in admin_hub.admin_users %}
                        <option value="{{ user.id }}">{{ user.full_name|default:user.username }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="mt-2 inline-flex items-center justify-center rounded-full bg-gradient-to-r from-lavender-400 to-sage-500 text-sage-900 font-semibold px-5 py-2 shadow">
                    Add Task
                </button>
            </form>
        </details>

        <div class="space-y-5">
            {% for task in admin_hub.tasks %}
            <article class="rounded-3xl border border-sage-200 dark:border-sage-700 bg-white/90 dark:bg-sage-950/70 p-5 shadow-lg">
                <div class="flex flex-wrap items-start justify-between gap-4 mb-3">
                    <div>
                        <h3 class="text-xl font-serif font-semibold text-sage-800 dark:text-cream-100">{{ task.title }}</h3>
                        <p class="text-sm text-sage-500 dark:text-sage-400">{{ task.description }}</p>
                    </div>
                    <form method="post" action="{% url 'chat_task_delete' task.id %}" hx-post="{% url 'chat_task_delete' task.id %}" hx-target="#admin-hub-tasks" hx-swap="outerHTML" hx-indicator="#admin-hub-tasks-indicator">
                        {% csrf_token %}
                        <button type="submit" class="text-xs text-red-600 dark:text-red-400 hover:underline">Remove</button>
                    </form>
                </div>
                <div class="flex flex-wrap gap-4 text-xs uppercase tracking-wide text-sage-600 dark:text-sage-300 mb-4">
                    <span>Status: <strong>{{ task.status_label }}</strong></span>
                    <span>Priority: <strong>{{ task.priority_label }}</strong></span>
                    <span>Due: <strong>{% if task.due_date_human %}{{ task.due_date_human }}{% else %}TBD{% endif %}{% if task.is_overdue %} (Overdue){% endif %}</strong></span>
                    <span>Assignee: <strong>{{ task.assigned_to_name }}</strong></span>
                </div>
                <div class="form-grid md-two mb-4">
                    <form method="post" action="{% url 'chat_task_status' task.id %}" hx-post="{% url 'chat_task_status' task.id %}" hx-target="#admin-hub-tasks" hx-swap="outerHTML" hx-indicator="#admin-hub-tasks-indicator" class="flex gap-2 items-center">
                        {% csrf_token %}
                        <label class="text-sm text-sage-600 dark:text-sage-400">Status</label>
                        <select name="status" class="flex-1 rounded-2xl border border-sage-200 dark:border-sage-700 bg-white/90 dark:bg-sage-950/70 px-3 py-2 text-sm text-sage-800 dark:text-cream-100">
                            {% for option in admin_hub.task_status_options %}
                            <option value="{{ option.value }}" {% if task.status == option.value %}selected{% endif %}>{{ option.label }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="text-xs text-sage-600 dark:text-sage-300 border border-sage-200 dark:border-sage-700 rounded-full px-3 py-1">Save</button>
                    </form>
                    <form method="post" action="{% url 'chat_task_assignment' task.id %}" hx-post="{% url 'chat_task_assignment' task.id %}" hx-target="#admin-hub-tasks" hx-swap="outerHTML" hx-indicator="#admin-hub-tasks-indicator" class="flex gap-2 items-center">
                        {% csrf_token %}
                        <label class="text-sm text-sage-600 dark:text-sage-400">Assignee</label>
                        <select name="assigned_to" class="flex-1 rounded-2xl border border-sage-200 dark:border-sage-700 bg-white/90 dark:bg-sage-950/70 px-3 py-2 text-sm text-sage-800 dark:text-cream-100">
                            <option value="">Unassigned</option>
                            {% for user in admin_hub.admin_users %}
                            <option value="{{ user.id }}" {% if task.assigned_to_id == user.id %}selected{% endif %}>{{ user.full_name|default:user.username }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="text-xs text-sage-600 dark:text-sage-300 border border-sage-200 dark:border-sage-700 rounded-full px-3 py-1">Save</button>
                    </form>
                </div>
                <div class="mb-4">
                    <p class="text-sm font-semibold text-sage-700 dark:text-cream-200 mb-2">Checklist ({{ task.completed_todos }}/{{ task.completed_todos|add:task.outstanding_todos }})</p>
                    <div class="space-y-2">
                        {% for todo in task.todos %}
                        <form method="post" action="{% url 'chat_task_toggle_todo' todo.id %}" hx-post="{% url 'chat_task_toggle_todo' todo.id %}" hx-target="#admin-hub-tasks" hx-swap="outerHTML" hx-indicator="#admin-hub-tasks-indicator" class="flex items-center gap-2">
                            {% csrf_token %}
                            <input type="hidden" name="is_done" value="{% if todo.is_done %}0{% else %}1{% endif %}">
                            <button type="submit" class="text-left flex-1 text-sm {% if todo.is_done %}line-through text-sage-400 dark:text-sage-500{% else %}text-sage-700 dark:text-cream-100{% endif %}">
                                {{ todo.label }}
                            </button>
                            <span class="text-xs text-sage-500 dark:text-sage-400">{{ todo.created_at_human }}</span>
                        </form>
                        {% empty %}
                        <p class="text-sm text-sage-500 dark:text-sage-400">No checklist items yet.</p>
                        {% endfor %}
                    </div>
                    <form method="post" action="{% url 'chat_task_add_todo' task.id %}" hx-post="{% url 'chat_task_add_todo' task.id %}" hx-target="#admin-hub-tasks" hx-swap="outerHTML" hx-indicator="#admin-hub-tasks-indicator" class="mt-2 flex gap-2">
                        {% csrf_token %}
                        <input type="text" name="label" placeholder="Add action step" class="flex-1 rounded-2xl border border-sage-200 dark:border-sage-700 bg-white/90 dark:bg-sage-950/70 px-3 py-2 text-sm text-sage-800 dark:text-cream-100" required>
                        <button type="submit" class="text-xs rounded-2xl bg-sage-700 text-white px-3 py-2">Add</button>
                    </form>
                </div>
            </article>
            {% empty %}
            <div class="text-center text-sage-600 dark:text-sage-300 py-12">
                No tasks yet. Use the form above to log the first one.
            </div>
            {% endfor %}
        </div>
    </div>
</section>
